<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gwent - Interface de Jeu</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <!-- Scripts CDN avec fallback local -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
    <script>window.Vue || document.write('<script src="vue.global.prod.js"><\/script>')</script>
    <script src="https://cdn.jsdelivr.net/npm/vue-demi@0.14.8/lib/index.iife.js"></script>
    <script>window.VueDemi || document.write('<script src="vue-demi.js"><\/script>')</script>
    <script src="https://cdn.jsdelivr.net/npm/pinia@2.1.7/dist/pinia.iife.js"></script>
    <script>window.Pinia || document.write('<script src="pinia.iife.js"><\/script>')</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="gwent_info_carte.js"></script>
    <script src="gwent_population.js"></script>
    <script src="gwent_moteur.js"></script>
    <script src="gwent_deck.js"></script>
    <script src="gwent_ia.js"></script>
    <style>
        body {
            background: url('bois2.png') no-repeat center center fixed, linear-gradient(135deg, #5c4033, #2f1d12);
            background-size: cover;
            font-family: 'Cinzel', serif;
            color: #fff;
            overflow: auto;
        }
        .card {
            background: linear-gradient(135deg, #d4af37, #8b5a2b);
            border: 3px solid #d4af37;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100px;
            height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
            position: relative;
            color: #fff;
            z-index: 10;
        }
        .card:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8);
        }
        .score-badge {
            background: #1a1a1a;
            border: 4px solid #d4af37;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
            z-index: 10;
        }
        .line {
            background: rgba(0, 0, 0, 0.4);
            border: 3px solid #8b5a2b;
            border-radius: 10px;
            min-height: 130px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin: 10px 0;
            z-index: 5;
        }
        .line:hover {
            border-color: #d4af37;
        }
        .line.froid-mordant {
            background: rgba(0, 0, 0, 0.4) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="white" opacity="0.3" d="M10 2l-1.5 5.5L3 8l5 4-1.5 5.5L10 14l3.5 3.5L12 12l5-4-5.5-0.5L10 2z"/></svg>') repeat;
        }
        .line.brouillard-impenetrable {
            background: rgba(0, 0, 0, 0.4) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="8" fill="white" opacity="0.2"/></svg>') repeat;
        }
        .line.pluie-torentielle {
            background: rgba(0, 0, 0, 0.4) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="white" opacity="0.3" d="M5,14 L7,8 L9,14 L8,16 L6,16 Z"/></svg>') repeat;
        }
        .line.incineration {
            background: rgba(0, 0, 0, 0.4) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="orange" opacity="0.3" d="M10,2 C8,4 6,6 6,8 C6,10 8,12 10,14 C12,12 14,10 14,8 C14,6 12,4 10,2 Z"/></svg>') repeat;
        }
        .parchment-button {
            background: linear-gradient(135deg, #8b5a2b, #5c4033);
            border: 2px solid #d4af37;
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .parchment-button:hover {
            background: linear-gradient(135deg, #a67c52, #7a5233);
        }
        .modal {
            background: linear-gradient(135deg, #d4af37, #8b5a2b);
            border: 3px solid #d4af37;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.8);
            padding: 20px;
            max-width: 400px;
            text-align: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            color: #fff;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        .journal {
            background: linear-gradient(135deg, #d4af37, #8b5a2b);
            border: 3px solid #d4af37;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.6);
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            width: 250px;
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 10;
            color: #fff;
        }
        .journal-entry {
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
        window.onload = function() {
            try {
                // Vérification des dépendances
                console.log('Vérification des dépendances...');
                console.log('Vue chargé:', !!window.Vue);
                console.log('VueDemi chargé:', !!window.VueDemi);
                console.log('Pinia chargé:', !!window.Pinia);
                console.log('GwentPopulation chargé:', !!window.GwentPopulation);
                console.log('GwentMoteur chargé:', !!window.GwentMoteur);
                console.log('GwentDeck chargé:', !!window.GwentDeck);
                console.log('GwentIA chargé:', !!window.GwentIA);

                if (!window.Vue || !window.VueDemi || !window.Pinia) {
                    console.error('Erreur: Vue, VueDemi ou Pinia non chargé.');
                    throw new Error('Vue/Pinia non chargé');
                }
                if (!window.GwentPopulation || !window.GwentMoteur || !window.GwentDeck || !window.GwentIA) {
                    console.error('Erreur: Une ou plusieurs dépendances Gwent manquantes.');
                    throw new Error('Dépendances Gwent manquantes');
                }

                const { createApp, reactive } = Vue;
                const { createPinia, defineStore } = Pinia;

                // Pinia Store
                const store = defineStore('game', {
                    state: () => {
                        console.log('Initialisation du store...');
                        const plateau = window.GwentPopulation?.PlateauTemplate
                            ? JSON.parse(JSON.stringify(window.GwentPopulation.PlateauTemplate))
                            : { 
                                joueur1: { deck: [], main: [], lignes: { melee: [], ranged: [], siege: [] }, score: 0, statut: 'actif', victoires: 0 },
                                joueur2: { deck: [], main: [], lignes: { melee: [], ranged: [], siege: [] }, score: 0, statut: 'actif', victoires: 0 },
                                meteo: { melee: null, ranged: null, siege: null }, 
                                manches: 1, 
                                tours: 1 
                            };
                        return {
                            plateau,
                            royaumeJ1: null,
                            royaumeJ2: 'Nilfgaard',
                            currentPlayer: 'joueur1',
                            gameStarted: false,
                            showFactionModal: true,
                            modal: { show: false, carte: null, type: '', data: null },
                            journal: [],
                            sounds: {
                                parchment: new Howl({ src: ['parchment.mp3'], volume: 0.5, preload: true, onloaderror: () => console.warn('Son parchment.mp3 non chargé') }),
                                wind: new Howl({ src: ['wind.mp3'], volume: 0.3, loop: true, preload: true, onloaderror: () => console.warn('Son wind.mp3 non chargé') }),
                                horn: new Howl({ src: ['horn.mp3'], volume: 0.5, preload: true, onloaderror: () => console.warn('Son horn.mp3 non chargé') }),
                                bell: new Howl({ src: ['bell.mp3'], volume: 0.5, preload: true, onloaderror: () => console.warn('Son bell.mp3 non chargé') })
                            }
                        };
                    },
                    actions: {
                        selectFaction(faction) {
                            console.log('Faction sélectionnée:', faction);
                            this.royaumeJ1 = faction;
                            this.showFactionModal = false;
                            this.journal.push(`${new Date().toLocaleString()}: Faction ${faction} choisie.`);
                        },
                        initializeGame() {
                            if (!this.royaumeJ1) {
                                this.showFactionModal = true;
                                return;
                            }
                            console.log('Initialisation du jeu avec royaumeJ1:', this.royaumeJ1);
                            this.plateau.joueur1.deck = window.GwentDeck?.genererDeck?.(this.royaumeJ1, 10) || [];
                            this.plateau.joueur2.deck = window.GwentDeck?.genererDeck?.(this.royaumeJ2, 10) || [];
                            for (let i = 0; i < 10; i++) {
                                if (this.plateau.joueur1.deck.length > 0) {
                                    this.plateau.joueur1.main.push(this.plateau.joueur1.deck.shift());
                                }
                                if (this.plateau.joueur2.deck.length > 0) {
                                    this.plateau.joueur2.main.push(this.plateau.joueur2.deck.shift());
                                }
                            }
                            this.gameStarted = true;
                            this.journal.push(`${new Date().toLocaleString()}: Partie démarrée !`);
                            this.sounds.horn.play();
                            window.GwentMoteur?.mettreAJourScores?.(this.plateau);
                            console.log('Plateau après initialisation:', JSON.stringify(this.plateau, null, 2));
                        },
                        playCard(joueur, carteId, position) {
                            const id = parseInt(carteId);
                            if (isNaN(id)) {
                                console.error('carteId invalide:', carteId);
                                return;
                            }
                            const carte = this.plateau[joueur].main.find(c => c?.id === id);
                            if (!carte) {
                                console.error('Carte non trouvée:', id);
                                return;
                            }
                            this.journal.push(`${new Date().toLocaleString()}: ${joueur === 'joueur1' ? 'Joueur' : 'IA'} joue ${carte.nom} sur ${position}`);
                            this.sounds.parchment.play();
                            if (Array.isArray(carte.ligne) && carte.ligne.length > 1 && joueur === 'joueur1') {
                                this.modal = {
                                    show: true,
                                    carte,
                                    type: 'agile',
                                    data: { carteId: id, joueur }
                                };
                            } else {
                                this.plateau = window.GwentMoteur?.jouerCarte?.(this.plateau, joueur, id, position) || this.plateau;
                                window.GwentMoteur?.mettreAJourScores?.(this.plateau);
                                if (this.plateau.meteo[position]) {
                                    if (this.plateau.meteo[position] === 'Froid Mordant' && !this.sounds.wind.playing()) {
                                        this.sounds.wind.play();
                                    }
                                } else if (this.sounds.wind.playing()) {
                                    this.sounds.wind.stop();
                                }
                                if (joueur === 'joueur1') {
                                    this.currentPlayer = 'joueur2';
                                    this.playIACard();
                                } else {
                                    this.currentPlayer = 'joueur1';
                                }
                            }
                            if (this.plateau.joueur1.statut === 'passe' && this.plateau.joueur2.statut === 'passe') {
                                this.endManche();
                            }
                            console.log('Plateau après jouerCarte:', JSON.stringify(this.plateau, null, 2));
                        },
                        selectAgileLine(carteId, joueur, position) {
                            const id = parseInt(carteId);
                            if (isNaN(id)) {
                                console.error('carteId invalide:', carteId);
                                return;
                            }
                            const carte = this.plateau[joueur].main.find(c => c?.id === id);
                            if (!carte) {
                                console.error('Carte non trouvée pour ligne agile:', id);
                                return;
                            }
                            this.journal.push(`${new Date().toLocaleString()}: ${joueur === 'joueur1' ? 'Joueur' : 'IA'} choisit ${position} pour ${carte.nom}`);
                            this.sounds.parchment.play();
                            this.plateau = window.GwentMoteur?.jouerCarte?.(this.plateau, joueur, id, position) || this.plateau;
                            window.GwentMoteur?.mettreAJourScores?.(this.plateau);
                            if (this.plateau.meteo[position]) {
                                if (this.plateau.meteo[position] === 'Froid Mordant' && !this.sounds.wind.playing()) {
                                    this.sounds.wind.play();
                                }
                            } else if (this.sounds.wind.playing()) {
                                this.sounds.wind.stop();
                            }
                            this.modal = { show: false, carte: null, type: '', data: null };
                            if (joueur === 'joueur1') {
                                this.currentPlayer = 'joueur2';
                                this.playIACard();
                            } else {
                                this.currentPlayer = 'joueur1';
                            }
                            if (this.plateau.joueur1.statut === 'passe' && this.plateau.joueur2.statut === 'passe') {
                                this.endManche();
                            }
                        },
                        async playIACard() {
                            if (this.plateau.joueur2.statut !== 'passe' && this.gameStarted) {
                                const scoreAdvantage = this.plateau.joueur2.score - this.plateau.joueur1.score;
                                const hasStrongCards = this.plateau.joueur2.main.some(carte => {
                                    const effectiveForce = this.plateau.meteo[carte.ligne?.toLowerCase?.() || 'melee'] === 'Froid Mordant' ? 1 : carte.force;
                                    return effectiveForce >= 3;
                                });
                                if (scoreAdvantage > 20 || !hasStrongCards) {
                                    this.journal.push(`${new Date().toLocaleString()}: IA passe le tour (avantage: ${scoreAdvantage}, cartes faibles: ${!hasStrongCards})`);
                                    this.plateau = window.GwentMoteur?.passerTour?.(this.plateau, 'joueur2') || this.plateau;
                                    this.currentPlayer = 'joueur1';
                                    if (this.plateau.joueur1.statut === 'passe' && this.plateau.joueur2.statut === 'passe') {
                                        this.endManche();
                                    }
                                    return;
                                }
                                const carteId = await window.GwentIA?.proposerCarte?.(this.plateau, 'joueur2');
                                if (carteId) {
                                    const id = parseInt(carteId);
                                    const carte = this.plateau.joueur2.main.find(c => c?.id === id);
                                    const position = carte && carte.ligne ? this.normalizeLigne(carte.ligne) : 'melee';
                                    setTimeout(() => {
                                        this.playCard('joueur2', id, position);
                                    }, 1000);
                                } else {
                                    this.journal.push(`${new Date().toLocaleString()}: IA passe le tour`);
                                    this.plateau = window.GwentMoteur?.passerTour?.(this.plateau, 'joueur2') || this.plateau;
                                    this.currentPlayer = 'joueur1';
                                    if (this.plateau.joueur1.statut === 'passe' && this.plateau.joueur2.statut === 'passe') {
                                        this.endManche();
                                    }
                                }
                            }
                        },
                        passerTour() {
                            this.journal.push(`${new Date().toLocaleString()}: Joueur passe le tour`);
                            this.plateau = window.GwentMoteur?.passerTour?.(this.plateau, 'joueur1') || this.plateau;
                            this.currentPlayer = 'joueur2';
                            if (this.plateau.joueur1.statut === 'passe' && this.plateau.joueur2.statut === 'passe') {
                                this.endManche();
                            } else {
                                this.playIACard();
                            }
                        },
                        endManche() {
                            this.journal.push(`${new Date().toLocaleString()}: Fin de la manche ${this.plateau.manches}`);
                            this.sounds.bell.play();
                            this.plateau = window.GwentMoteur?.terminerManche?.(this.plateau) || this.plateau;
                            const winner = this.plateau.joueur1.score > this.plateau.joueur2.score ? 'joueur1' : 
                                          this.plateau.joueur1.score < this.plateau.joueur2.score ? 'joueur2' : null;
                            if (winner) {
                                this.plateau[winner].victoires = (this.plateau[winner].victoires || 0) + 1;
                                this.journal.push(`${new Date().toLocaleString()}: ${winner === 'joueur1' ? 'Joueur' : 'IA'} gagne la manche !`);
                            } else {
                                this.journal.push(`${new Date().toLocaleString()}: Égalité pour la manche.`);
                            }
                            if (this.plateau.joueur1.victoires >= 2 || this.plateau.joueur2.victoires >= 2) {
                                const gameWinner = this.plateau.joueur1.victoires >= 2 ? 'joueur1' : 'joueur2';
                                this.journal.push(`${new Date().toLocaleString()}: ${gameWinner === 'joueur1' ? 'Joueur' : 'IA'} gagne la partie !`);
                                this.modal = { 
                                    show: true, 
                                    carte: null, 
                                    type: 'victory', 
                                    data: { winner: gameWinner === 'joueur1' ? this.royaumeJ1 : this.royaumeJ2 }
                                };
                                this.gameStarted = false;
                                this.sounds.wind.stop();
                                return;
                            }
                            if (this.plateau.manches < 3) {
                                this.plateau.manches += 1;
                                this.plateau.tours = 1;
                                this.plateau.joueur1.lignes = { melee: [], ranged: [], siege: [] };
                                this.plateau.joueur2.lignes = { melee: [], ranged: [], siege: [] };
                                this.plateau.meteo = { melee: null, ranged: null, siege: null };
                                this.plateau.joueur1.statut = 'actif';
                                this.plateau.joueur2.statut = 'actif';
                                this.plateau.joueur1.score = 0;
                                this.plateau.joueur2.score = 0;
                                for (let i = 0; i < 2; i++) {
                                    if (this.plateau.joueur1.deck.length > 0) {
                                        this.plateau.joueur1.main.push(this.plateau.joueur1.deck.shift());
                                    }
                                    if (this.plateau.joueur2.deck.length > 0) {
                                        this.plateau.joueur2.main.push(this.plateau.joueur2.deck.shift());
                                    }
                                }
                                window.GwentMoteur?.mettreAJourScores?.(this.plateau);
                            }
                            this.currentPlayer = 'joueur1';
                            this.sounds.wind.stop();
                            console.log('Plateau après fin de manche:', JSON.stringify(this.plateau, null, 2));
                        },
                        showCardModal(carte) {
                            if (carte) {
                                this.modal = { show: true, carte, type: 'description', data: null };
                            }
                        },
                        closeModal() {
                            this.modal = { show: false, carte: null, type: '', data: null };
                        },
                        normalizeLigne(ligne) {
                            if (Array.isArray(ligne) && ligne.length > 0) {
                                return ligne[0].toLowerCase();
                            } else if (typeof ligne === 'string' && ligne.length > 0) {
                                return ligne.toLowerCase();
                            }
                            return 'melee';
                        }
                    }
                });

                // Composant FactionModal
                const FactionModal = {
                    props: ['show', 'store'],
                    template: `
                        <div v-if="show" class="modal-overlay" @click="store.closeModal">
                            <div class="modal" @click.stop>
                                <div class="text-xl font-bold mb-4">Choisir votre faction</div>
                                <div class="flex flex-wrap gap-2 justify-center">
                                    <button v-for="faction in factions" :key="faction"
                                            class="parchment-button"
                                            @click="store.selectFaction(faction)">
                                        {{ faction }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `,
                    setup() {
                        console.log('Rendu de FactionModal');
                        const factions = [
                            'Royaumes du Nord',
                            'Nilfgaard',
                            'Scoia’tael',
                            'Skellige',
                            'Monstres'
                        ];
                        return { factions };
                    }
                };

                // Composant Modal
                const Modal = {
                    props: ['modal', 'store'],
                    template: `
                        <div v-if="modal.show" class="modal-overlay" @click="store.closeModal">
                            <div class="modal" @click.stop>
                                <div v-if="modal.type === 'description'">
                                    <div class="text-xl font-bold mb-2">{{ modal.carte?.nom || 'Nom inconnu' }}</div>
                                    <div>Force: {{ modal.carte?.force || 0 }}</div>
                                    <div>Ligne: {{ modal.carte?.ligne ? (Array.isArray(modal.carte.ligne) ? modal.carte.ligne.join(', ') : modal.carte.ligne) : 'Inconnue' }}</div>
                                    <div>Capacité: {{ modal.carte?.capacite || 'Aucune' }}</div>
                                    <div class="mt-2 text-sm">{{ modal.carte?.description || 'Pas de description' }}</div>
                                    <button class="parchment-button mt-4" @click="store.closeModal">Fermer</button>
                                </div>
                                <div v-if="modal.type === 'agile'">
                                    <div class="text-xl font-bold mb-2">Choisir une ligne pour {{ modal.carte?.nom || 'Carte' }}</div>
                                    <div class="flex gap-2 justify-center">
                                        <button v-for="ligne in modal.carte?.ligne || []" :key="ligne"
                                                class="parchment-button"
                                                @click="store.selectAgileLine(modal.data?.carteId, modal.data?.joueur, ligne.toLowerCase())">
                                            {{ ligne }}
                                        </button>
                                    </div>
                                </div>
                                <div v-if="modal.type === 'victory'">
                                    <div class="text-xl font-bold mb-2">Victoire !</div>
                                    <div>{{ modal.data?.winner || 'Inconnu' }} gagne la partie !</div>
                                    <button class="parchment-button mt-4" @click="store.closeModal">Fermer</button>
                                </div>
                            </div>
                        </div>
                    `,
                    mounted() {
                        console.log('Rendu de Modal:', this.modal);
                    }
                };

                // Composant Journal
                const Journal = {
                    props: ['journal'],
                    template: `
                        <div class="journal">
                            <div class="text-lg font-bold mb-2">Journal des actions</div>
                            <div v-for="(entry, index) in journal" :key="index" class="journal-entry">
                                {{ entry || 'Entrée vide' }}
                            </div>
                            <div v-if="!journal || journal.length === 0" class="journal-entry">
                                Aucune action enregistrée.
                            </div>
                        </div>
                    `,
                    mounted() {
                        console.log('Rendu de Journal:', this.journal);
                    }
                };

                // Composant Carte
                const Carte = {
                    props: ['carte', 'joueur', 'isDraggable'],
                    template: `
                        <div class="card text-center cursor-pointer relative"
                             :class="{ 'opacity-50': !isDraggable }"
                             @click="zoomCard"
                             draggable="true"
                             @dragstart="dragStart"
                             @dragend="dragEnd">
                            <div class="text-sm font-bold">{{ carte?.nom || 'Nom inconnu' }}</div>
                            <div class="text-[18px] font-bold">{{ carte?.force || 0 }}</div>
                            <div class="text-sm">{{ carte?.ligne ? (Array.isArray(carte.ligne) ? carte.ligne.join(', ') : carte.ligne) : 'Inconnue' }}</div>
                            <div class="text-xs">{{ carte?.capacite || 'Aucune' }}</div>
                        </div>
                    `,
                    methods: {
                        zoomCard() {
                            if (this.isDraggable || this.joueur === 'joueur2') {
                                this.$emit('show-card-modal', this.carte);
                            }
                        },
                        dragStart(event) {
                            if (!this.isDraggable || !this.carte?.id) return;
                            event.dataTransfer.setData('carteId', this.carte.id.toString());
                            event.target.style.transform = 'scale(1.1)';
                            event.target.style.boxShadow = '0 12px 24px rgba(0, 0, 0, 0.8)';
                            gsap.to(event.target, { rotation: 5, duration: 0.2 });
                        },
                        dragEnd(event) {
                            if (!this.isDraggable) return;
                            event.target.style.transform = 'scale(1)';
                            event.target.style.boxShadow = '0 6px 12px rgba(0, 0, 0, 0.6)';
                            gsap.to(event.target, { rotation: 0, duration: 0.2 });
                        }
                    },
                    mounted() {
                        console.log('Rendu de Carte:', this.carte);
                    }
                };

                // Composant Ligne
                const Ligne = {
                    props: ['cartes', 'type', 'joueur', 'isDropZone', 'meteo'],
                    template: `
                        <div class="line p-4 flex flex-wrap gap-2 justify-center"
                             :class="{ 'froid-mordant': meteo === 'Froid Mordant', 'brouillard-impenetrable': meteo === 'Brouillard Impénétrable', 'pluie-torentielle': meteo === 'Pluie Torentielle', 'incineration': meteo === 'Incinération' }"
                             @dragover.prevent
                             @drop="handleDrop"
                             ref="line">
                            <div class="absolute top-2 left-2 text-sm font-bold">{{ type || 'Ligne inconnue' }}</div>
                            <div class="absolute top-2 right-2 score-badge">{{ calculateLineScore() }}</div>
                            <div class="absolute inset-0" ref="canvas"></div>
                            <Carte v-for="carte in cartes" :key="carte?.id || index"
                                   :carte="carte" :joueur="joueur" :isDraggable="false"
                                   @show-card-modal="$emit('show-card-modal', carte)" />
                            <div v-if="!cartes || cartes.length === 0" class="text-sm text-white">Aucune carte</div>
                        </div>
                    `,
                    components: { Carte },
                    methods: {
                        handleDrop(event) {
                            if (!this.isDropZone) return;
                            const carteId = parseInt(event.dataTransfer.getData('carteId'));
                            if (isNaN(carteId)) {
                                console.error('carteId invalide lors du drop:', event.dataTransfer.getData('carteId'));
                                return;
                            }
                            const carte = this.joueur === 'joueur1' 
                                ? this.$root.store.plateau.joueur1.main.find(c => c?.id === carteId)
                                : this.$root.store.plateau.joueur2.main.find(c => c?.id === carteId);
                            if (!carte) {
                                console.error('Carte non trouvée:', carteId);
                                return;
                            }
                            const isAgile = Array.isArray(carte.ligne) && carte.ligne.length > 1;
                            const isValidLine = isAgile || (typeof carte.ligne === 'string' && carte.ligne.toLowerCase() === this.type.toLowerCase())							
														|| (Array.isArray(carte.ligne) && carte.ligne[0].toLowerCase() === this.type.toLowerCase());
                            if (!isValidLine) {
                                console.warn(`Carte ${carte.nom} ne peut pas être jouée sur ${this.type}`);
                                this.$root.store.journal.push(`${new Date().toLocaleString()}: Impossible de jouer ${carte.nom} sur ${this.type}`);
                                return;
                            }
                            this.$emit('play-card', this.joueur, carteId, this.type.toLowerCase());
                            gsap.to(this.$refs.line, {
                                scale: 1.1,
                                duration: 0.3,
                                ease: 'power2.out',
                                onComplete: () => gsap.to(this.$refs.line, { scale: 1, duration: 0.3 })
                            });
                        },
                        calculateLineScore() {
                            if (!this.cartes || this.cartes.length === 0) return 0;
                            let score = 0;
                            const meteo = this.meteo;
                            this.cartes.forEach(carte => {
                                if (meteo === 'Froid Mordant' && !carte.heros) {
                                    score += 1;
                                } else if (meteo === 'Incinération' && !carte.heros) {
                                    const maxForceCard = this.cartes.reduce((max, c) => (!c.heros && c.force > max.force) ? c : max, { force: 0 });
                                    if (carte === maxForceCard) score += 0;
                                    else score += carte.force;
                                } else {
                                    score += carte.force || 0;
                                }
                            });
                            return score;
                        }
                    },
                    mounted() {
                        console.log('Rendu de Ligne:', this.type, 'Cartes:', this.cartes, 'Météo:', this.meteo);
                        const app = new PIXI.Application({
                            width: this.$refs.canvas.offsetWidth,
                            height: this.$refs.canvas.offsetHeight,
                            transparent: true
                        });
                        this.$refs.canvas.appendChild(app.view);
                        if (this.meteo === 'Froid Mordant') {
                            const emitter = new PIXI.particles.Emitter(app.stage, {
                                lifetime: { min: 2, max: 5 },
                                frequency: 0.1,
                                spawnChance: 0.8,
                                particlesPerWave: 2,
                                emitterLifetime: 0,
                                maxParticles: 100,
                                pos: { x: 0, y: 0 },
                                behaviors: [
                                    { type: 'alpha', config: { alpha: { start: 0.8, end: 0 } } },
                                    { type: 'moveSpeed', config: { speed: { list: [{ value: 50, time: 0 }, { value: 20, time: 1 }], isStepped: false } } },
                                    { type: 'scale', config: { scale: { list: [{ value: 0.1, time: 0 }, { value: 0.05, time: 1 }], isStepped: false } } },
                                    { type: 'color', config: { color: { list: [{ value: 'ffffff', time: 0 }, { value: 'ffffff', time: 1 }], isStepped: false } } },
                                    { type: 'spawnShape', config: { type: 'rect', data: { x: 0, y: 0, w: this.$refs.canvas.offsetWidth, h: 20 } } },
                                    { type: 'textureSingle', config: { texture: PIXI.Texture.from('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><circle cx="5" cy="5" r="5" fill="white"/></svg>') } }
                                ]
                            });
                            app.ticker.add(() => emitter.update(0.016));
                        } else if (this.meteo === 'Brouillard Impénétrable') {
                            const emitter = new PIXI.particles.Emitter(app.stage, {
                                lifetime: { min: 3, max: 7 },
                                frequency: 0.2,
                                spawnChance: 0.7,
                                particlesPerWave: 3,
                                emitterLifetime: 0,
                                maxParticles: 50,
                                pos: { x: 0, y: 0 },
                                behaviors: [
                                    { type: 'alpha', config: { alpha: { start: 0.5, end: 0 } } },
                                    { type: 'moveSpeed', config: { speed: { list: [{ value: 30, time: 0 }, { value: 10, time: 1 }], isStepped: false } } },
                                    { type: 'scale', config: { scale: { list: [{ value: 0.2, time: 0 }, { value: 0.1, time: 1 }], isStepped: false } } },
                                    { type: 'color', config: { color: { list: [{ value: 'cccccc', time: 0 }, { value: 'aaaaaa', time: 1 }], isStepped: false } } },
                                    { type: 'spawnShape', config: { type: 'rect', data: { x: 0, y: 0, w: this.$refs.canvas.offsetWidth, h: this.$refs.canvas.offsetHeight } } },
                                    { type: 'textureSingle', config: { texture: PIXI.Texture.from('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15"><circle cx="7.5" cy="7.5" r="7" fill="white" opacity="0.4"/></svg>') } }
                                ]
                            });
                            app.ticker.add(() => emitter.update(0.016));
                        } else if (this.meteo === 'Pluie Torentielle') {
                            const emitter = new PIXI.particles.Emitter(app.stage, {
                                lifetime: { min: 1, max: 3 },
                                frequency: 0.05,
                                spawnChance: 0.9,
                                particlesPerWave: 5,
                                emitterLifetime: 0,
                                maxParticles: 200,
                                pos: { x: 0, y: 0 },
                                behaviors: [
                                    { type: 'alpha', config: { alpha: { start: 0.7, end: 0 } } },
                                    { type: 'moveSpeed', config: { speed: { list: [{ value: 100, time: 0 }, { value: 50, time: 1 }], isStepped: false } } },
                                    { type: 'scale', config: { scale: { list: [{ value: 0.05, time: 0 }, { value: 0.02, time: 1 }], isStepped: false } } },
                                    { type: 'color', config: { color: { list: [{ value: '88aaff', time: 0 }, { value: '6699ff', time: 1 }], isStepped: false } } },
                                    { type: 'spawnShape', config: { type: 'rect', data: { x: 0, y: 0, w: this.$refs.canvas.offsetWidth, h: 20 } } },
                                    { type: 'textureSingle', config: { texture: PIXI.Texture.from('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="5" height="10"><rect x="2" y="0" width="2" height="10" fill="white"/></svg>') } }
                                ]
                            });
                            app.ticker.add(() => emitter.update(0.016));
                        } else if (this.meteo === 'Incinération') {
                            const emitter = new PIXI.particles.Emitter(app.stage, {
                                lifetime: { min: 1, max: 2 },
                                frequency: 0.05,
                                spawnChance: 0.8,
                                particlesPerWave: 4,
                                emitterLifetime: 0,
                                maxParticles: 150,
                                pos: { x: 0, y: this.$refs.canvas.offsetHeight },
                                behaviors: [
                                    { type: 'alpha', config: { alpha: { start: 0.9, end: 0 } } },
                                    { type: 'moveSpeed', config: { speed: { list: [{ value: -80, time: 0 }, { value: -30, time: 1 }], isStepped: false } } },
                                    { type: 'scale', config: { scale: { list: [{ value: 0.1, time: 0 }, { value: 0.05, time: 1 }], isStepped: false } } },
                                    { type: 'color', config: { color: { list: [{ value: 'ff4500', time: 0 }, { value: 'ffa500', time: 1 }], isStepped: false } } },
                                    { type: 'spawnShape', config: { type: 'rect', data: { x: 0, y: 0, w: this.$refs.canvas.offsetWidth, h: 20 } } },
                                    { type: 'textureSingle', config: { texture: PIXI.Texture.from('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="10" height="10"><circle cx="5" cy="5" r="5" fill="orange"/></svg>') } }
                                ]
                            });
                            app.ticker.add(() => emitter.update(0.016));
                        }
                    }
                };

                // Composant Main
                const Main = {
                    props: ['cartes', 'joueur', 'isActive'],
                    template: `
                        <div class="flex justify-center gap-2 mt-4" ref="main">
                            <Carte v-for="carte in cartes" :key="carte?.id || index"
                                   :carte="carte" :joueur="joueur" :isDraggable="isActive"
                                   @show-card-modal="$emit('show-card-modal', carte)" />
                            <div v-if="!cartes || cartes.length === 0" class="text-sm text-white">Aucune carte dans la main</div>
                        </div>
                    `,
                    components: { Carte },
                    watch: {
                        isActive(newValue) {
                            if (newValue) {
                                gsap.to(this.$refs.main, {
                                    scale: 1.1,
                                    duration: 0.3,
                                    ease: 'power2.out',
                                    onComplete: () => gsap.to(this.$refs.main, { scale: 1, duration: 0.3 })
                                });
                            }
                        }
                    },
                    mounted() {
                        console.log('Rendu de Main:', this.cartes);
                    }
                };

                // Composant PastilleScore
                const PastilleScore = {
                    props: ['score', 'joueur'],
                    template: `
                        <div class="score-badge text-lg font-bold">{{ score || 0 }}</div>
                    `,
                    watch: {
                        score(newScore, oldScore) {
                            gsap.to(this.$el, {
                                scale: 1.2,
                                duration: 0.3,
                                ease: 'elastic.out(1, 0.3)',
                                onComplete: () => gsap.to(this.$el, { scale: 1, duration: 0.3 })
                            });
                        }
                    },
                    mounted() {
                        console.log('Rendu de PastilleScore:', this.score, 'Joueur:', this.joueur);
                    }
                };

                // Composant Plateau
                const Plateau = {
                    template: `
                        <div class="flex flex-col items-center min-h-screen py-4" ref="plateau">
                            <!-- Journal -->
                            <Journal :journal="store.journal" />
                            <!-- Côté adversaire -->
                            <div class="w-full max-w-4xl">
                                <div class="flex justify-between items-center mb-2">
                                    <h2 class="text-xl font-bold">Adversaire ({{ store.royaumeJ2 || 'Inconnu' }}<span v-if="store.plateau.joueur2.statut === 'passe'">, Passe</span>) - {{ store.plateau.joueur2.score || 0 }}</h2>
                                </div>
                                <Ligne :cartes="store.plateau.joueur2.lignes.siege" type="Siege" joueur="joueur2" :isDropZone="false"
                                       :meteo="store.plateau.meteo.siege" @show-card-modal="store.showCardModal" />
                                <Ligne :cartes="store.plateau.joueur2.lignes.ranged" type="Ranged" joueur="joueur2" :isDropZone="false"
                                       :meteo="store.plateau.meteo.ranged" @show-card-modal="store.showCardModal" />
                                <Ligne :cartes="store.plateau.joueur2.lignes.melee" type="Melee" joueur="joueur2" :isDropZone="false"
                                       :meteo="store.plateau.meteo.melee" @show-card-modal="store.showCardModal" />
                            </div>
                            <!-- Côté joueur -->
                            <div class="w-full max-w-4xl">
                                <div class="flex justify-between items-center mb-2">
                                    <h2 class="text-xl font-bold">Joueur ({{ store.royaumeJ1 || 'Inconnu' }}<span v-if="store.plateau.joueur1.statut === 'passe'">, Passe</span>) - {{ store.plateau.joueur1.score || 0 }}</h2>
                                    <div class="text-sm">
                                        <div>Manche: {{ store.plateau.manches || 1 }}/3</div>
                                        <div>Tour: {{ store.plateau.tours || 1 }}</div>
                                    </div>
                                </div>
                                <Ligne :cartes="store.plateau.joueur1.lignes.melee" type="Melee" joueur="joueur1" :isDropZone="store.currentPlayer === 'joueur1' && store.gameStarted"
                                       :meteo="store.plateau.meteo.melee" @play-card="store.playCard" @show-card-modal="store.showCardModal" />
                                <Ligne :cartes="store.plateau.joueur1.lignes.ranged" type="Ranged" joueur="joueur1" :isDropZone="store.currentPlayer === 'joueur1' && store.gameStarted"
                                       :meteo="store.plateau.meteo.ranged" @play-card="store.playCard" @show-card-modal="store.showCardModal" />
                                <Ligne :cartes="store.plateau.joueur1.lignes.siege" type="Siege" joueur="joueur1" :isDropZone="store.currentPlayer === 'joueur1' && store.gameStarted"
                                       :meteo="store.plateau.meteo.siege" @play-card="store.playCard" @show-card-modal="store.showCardModal" />
                                <Main :cartes="store.plateau.joueur1.main" joueur="joueur1" :isActive="store.currentPlayer === 'joueur1' && store.gameStarted"
                                      @show-card-modal="store.showCardModal" />
                                <button v-if="store.currentPlayer === 'joueur1' && store.gameStarted" class="parchment-button mt-4"
                                        @click="store.passerTour()">Passer le tour</button>
                            </div>
                            <Modal :modal="store.modal" :store="store" />
                        </div>
                    `,
                    components: { Ligne, Main, Journal, Modal },
                    mounted() {
                        console.log('Rendu de Plateau:', {
                            royaumeJ1: this.store.royaumeJ1,
                            royaumeJ2: this.store.royaumeJ2,
                            plateau: this.store.plateau
                        });
                        gsap.from(this.$refs.plateau, {
                            scale: 0.8,
                            opacity: 0,
                            duration: 1,
                            ease: 'power2.out',
                            onComplete: () => {
                                gsap.to(this.$refs.plateau, {
                                    scale: 1,
                                    duration: 0.5,
                                    ease: 'power2.inOut'
                                });
                            }
                        });
                    },
                    setup() {
                        return { store: store() };
                    }
                };

                // Application
                const app = createApp({
                    template: `
                        <div>
                            <FactionModal v-if="store.showFactionModal" :show="store.showFactionModal" :store="store" />
                            <div v-else-if="!store.gameStarted && !store.modal.show" class="text-center mt-20">
                                <h1 class="text-4xl font-bold mb-4 text-white">Gwent</h1>
                                <button class="parchment-button px-6 py-3"
                                        @click="store.initializeGame()">Démarrer la partie</button>
                            </div>
                            <Plateau v-else />
                            <div v-if="error" class="text-center text-red-500 mt-4">
                                Erreur: {{ error }}
                            </div>
                        </div>
                    `,
                    components: { Plateau, FactionModal },
                    setup() {
                        const gameStore = store();
                        console.log('Store initialisé:', gameStore);
                        const error = reactive({ message: null });
                        try {
                            console.log('Rendu du composant racine');
                            return { store: gameStore, error };
                        } catch (e) {
                            error.message = e.message;
                            console.error('Erreur dans le rendu racine:', e);
                            return { store: gameStore, error };
                        }
                    }
                });

                app.use(createPinia()).mount('#app');
            } catch (e) {
                console.error('Erreur lors de l’initialisation de l’application:', e);
            }
        };
    </script>
</body>
</html>