<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Cup All-Time Ranking 1930-2022</title>
    
    <style>
        /* --- General Style --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5; 
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 3px 20px 10px 20px; 
            box-sizing: border-box;
            overflow-x: hidden;
            font-size: 0.8em; 
        }

        .main-content-wrapper {
            display: flex;
            gap: 15px; 
            width: 100%;
            align-items: flex-start;
            min-height: calc(100vh - 13px); 
        }
        
        /* --- Screens Styles --- */
        .overlay-screen {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(240, 242, 245, 0.95); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 100; 
            backdrop-filter: blur(2px); 
            text-align: center; 
            padding: 20px; 
            box-sizing: border-box;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .screen-content {
            background-color: rgba(255,255,255,0.9); 
            padding: 15px 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            max-width: 600px;
            width: 100%;
            text-align: left;
            max-height: 80vh; 
            overflow-y: auto; 
        }
        
        .screen-title {
            color: #1e3a5f; 
            font-size: 1.5em; 
            margin-bottom: 25px;
            text-align: center;
        }
        
        .next-btn {
            background-color: #4e73df;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        .next-btn:hover {
            background-color: #224abe;
        }

        /* --- Filtering Styles --- */
        .filter-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }

        .filter-section h3 {
            color: #1e3a5f;
            font-size: 1.1em;
            margin-top: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }

        .region-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
        }

        .region-item {
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }
        
        .region-item label {
            margin-left: 5px;
            cursor: pointer;
            width: 100%;
        }

        .edition-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .edition-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        .edition-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #4e73df;
        }

        .edition-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
            font-size: 1em;
        }

        /* --- Left Column: Competitions and Year --- */
        .competitions-column {
            width: 110px; 
            flex-shrink: 0;
            padding-top: 3px; 
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 13px - 3px); 
        }
        
        #year-display-in-column {
            font-size: 1.725em; 
            color: #1e3a5f;
            margin: 0 0 5px 0; 
            font-weight: 800;
            text-align: center;
            line-height: 1; 
        }

        .competitions-display {
            display: flex;
            flex-direction: column; 
            gap: 6px; 
            max-height: 100vh; 
            flex-grow: 1; 
            overflow: hidden; 
            align-items: flex-start;
            position: relative; 
        }

        #all-competitions-scroll-container {
            position: relative;
            top: 0; 
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Container for competitions of a year */
        .year-group-container {
            position: relative; 
            width: 100%;
            margin-bottom: 6px; 
            flex-shrink: 0; 
        }
        
        /* --- Style : Year Separator --- */
        .year-separator {
            width: 100%;
            height: 20px; 
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 3px 0; 
            position: relative;
            flex-shrink: 0; 
        }
        
        .year-separator::before,
        .year-separator::after {
            content: '';
            flex-grow: 1;
            height: 1px;
            background-color: #ccc;
            margin: 0 5px;
        }

        .year-separator-text {
            font-size: 0.8em;
            font-weight: bold;
            color: #666;
            padding: 0 5px;
        }

        /* --- COMPETITION BOX STRUCTURE --- */
        .competition-box {
            position: relative; 
            width: 100%;
            height: 70px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            border-radius: 3px; 
            overflow: hidden; 
            transition: transform 0.2s ease;
            display: flex; 
            flex-direction: column; 
            margin-bottom: 6px; 
            flex-shrink: 0; 
            background-color: #fff;
        }
        
        .year-group-container .competition-box:last-child {
            margin-bottom: 0;
        }

        .competition-box:hover {
            transform: scale(1.03); 
            z-index: 5;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }

        /* --- Internal Rows for Organizer/Winner --- */
        .comp-info-row {
            height: 50%; 
            display: flex;
            align-items: center;
            padding: 0 5px;
            box-sizing: border-box;
            font-size: 0.6em;
            line-height: 1.1;
        }

        .comp-info-row.organizer {
            background-color: #4e73df; /* Light Blue */
            color: #fff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .comp-info-row.winner {
            background-color: #1e3a5f; /* Dark Blue */
            color: #fff;
        }

        .row-flag {
            width: 25px; 
            height: 18px; 
            object-fit: cover; 
            margin-right: 5px;
            flex-shrink: 0;
            border: 1px solid #fff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .row-text {
            font-weight: bold;
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .row-label {
             font-weight: normal;
             margin-right: 3px;
             opacity: 0.8;
             flex-shrink: 0;
        }

        /* --- RANKING --- */
        .no-competitions { font-size: 0.7em; margin-top: 5px; }
        .chart-container { flex-grow: 1; max-width: 600px; flex-shrink: 0; padding-top: 0; }
        #ranking-chart { position: relative; width: 100%; }
        
        .country-row {
            position: absolute;
            width: 100%;
            height: 35px; 
            display: flex;
            align-items: center;
            margin-bottom: 5px; 
            opacity: 0; 
            visibility: hidden; 
            background-color: transparent; 
            border-radius: 0; 
            box-shadow: none; 
            padding-right: 8px; 
        }
        
        .country-info { position: relative; width: 100%; display: flex; align-items: center; }
        .country-name { 
            position: absolute; top: 0px; left: 40px; font-size: 0.7em; font-weight: bold; color: #444; white-space: nowrap; 
        }
        
        .flag { 
            width: 35px; height: 35px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            margin-right: 1px; flex-shrink: 0; 
        }
        
        /* Transparent background for the progress bar */
        .progress-container { 
            flex-grow: 1; height: 6px; background-color: transparent; border-radius: 3px; overflow: hidden; margin-top: 15px; 
        }
        
        /* The progress-bar background will be defined by JS */
        .progress-bar { 
            width: 0%; height: 100%; border-radius: 3px; 
        }
        
        .trophy-count { 
            font-size: 1.1em; font-weight: bold; color: #1e3a5f; margin-left: 10px; width: 40px; text-align: center; flex-shrink: 0; 
        }

        /* Styling for the new score table */
        .score-table-container {
            font-size: 0.85em;
            color: #333;
            text-align: left;
            margin-top: 10px;
        }
        .score-table-container strong {
            color: #1e3a5f;
        }
        .rule-set {
            margin-bottom: 12px;
            padding: 8px;
            border-left: 3px solid #4e73df;
            background-color: #f8f9fa;
        }
        .rule-set-title {
            font-weight: bold;
            color: #1e3a5f;
            margin-bottom: 4px;
        }
        .rule-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .rule-list li {
            margin-bottom: 2px;
        }
        .base-points {
            font-weight: bold;
            color: #28a745; 
        }

    </style>
</head>
<body>
    
    <div id="start-screen" class="overlay-screen">
        <h1 class="screen-title">World Cup All-Time Ranking 1930-2022</h1>
        <div class="screen-content">
            <h2 style="color: #1e3a5f; font-size: 1.1em; margin-top: 0; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 8px; text-align: center;">Système de Points Dynamique (Bareme)</h2>
            
            <div class="score-table-container">
                <div class="base-points">Points de base: <strong>+3</strong> pour une victoire / <strong>+1</strong> pour un match nul</div>
                <br>
                
                <div class="rule-set">
                    <div class="rule-set-title">A. Tournoi avec Huitièmes (Format Moderne Standard)</div>
                    <ul class="rule-list">
                        <li>Champion: <strong>+3200</strong> pts</li>
                        <li>Finalist: <strong>+1600</strong> pts</li>
                        <li>Third Place Winner: <strong>+1200</strong> pts</li>
                        <li>Quarter-finalist: <strong>+800</strong> pts</li>
                        <li>Round of 16 Qualifier: <strong>+400</strong> pts</li>
                        <li>Phase de groupes (Pas de points supplémentaires au-delà des points de base)</li>
                    </ul>
                </div>

                <div class="rule-set">
                    <div class="rule-set-title">B. Tournoi avec Quarts de finale (Pas de Huitièmes)</div>
                    <ul class="rule-list">
                        <li>Champion: <strong>+1600</strong> pts</li>
                        <li>Finalist: <strong>+800</strong> pts</li>
                        <li>Third Place Winner: <strong>+600</strong> pts</li>
                        <li>Semi-finalist: <strong>+400</strong> pts</li>
                        <li>Quarter-finalist: <strong>+200</strong> pts</li>
                    </ul>
                </div>
                
                <div class="rule-set">
                    <div class="rule-set-title">C. Tournoi avec Demi-finales (Pas de Quarts/Huitièmes)</div>
                    <ul class="rule-list">
                        <li>Champion: <strong>+800</strong> pts</li>
                        <li>Finalist: <strong>+400</strong> pts</li>
                        <li>Third Place Winner: <strong>+300</strong> pts</li>
                        <li>Semi-finalist: <strong>+200</strong> pts</li>
                    </ul>
                </div>
                
                <div class="rule-set">
                    <div class="rule-set-title">D. Phase de groupe Finale Uniquement (e.g., 1950)</div>
                    <ul class="rule-list">
                        <li>Champion (1er place): <strong>+800</strong> pts</li>
                        <li>2nd place: <strong>+400</strong> pts</li>
                        <li>3rd place: <strong>+300</strong> pts</li>
                        <li>4th place: <strong>+200</strong> pts</li>
                    </ul>
                </div>
                
            </div>

            <button class="next-btn" onclick="showFilterScreen()">Continuer vers les filtres</button>
        </div>
    </div>

    <div id="filter-screen" class="overlay-screen" style="visibility: hidden; opacity: 0; display: none;">
        <h1 class="screen-title">Filtrer le Classement</h1>
        <div class="screen-content">
            
            <div class="filter-section">
                <h3>1. Filtrer par Région de Confédération</h3>
                <p style="font-size: 0.75em; color: #777; margin-bottom: 10px;">Sélectionnez les régions dont les pays seront inclus dans le classement.</p>
                <div class="region-grid" id="region-filters">
                    </div>
            </div>

            <div class="filter-section">
                <h3>2. Filtrer par Édition (Année et Hôte)</h3>
                <div class="edition-controls">
                    <div class="edition-group">
                        <label for="startEdition">Édition de Départ (Organisateur - Année)</label>
                        <select id="startEdition"></select>
                    </div>
                    <div class="edition-group">
                        <label for="endEdition">Édition d'Arrivée (Organisateur - Année)</label>
                        <select id="endEdition"></select>
                    </div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="next-btn" onclick="startRanking()">Lancer l'Animation</button>
            </div>
        </div>
    </div>
    
    <div class="main-content-wrapper" id="main-content-wrapper"> 
        
        <div class="competitions-column">
            <h2 id="year-display-in-column">1930</h2> 
            <div id="competitions-display" class="competitions-display">
                <p class="no-competitions">Chargement des données...</p>
            </div>
        </div>

        <div class="chart-container">
            <div id="ranking-chart">
            </div>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            const BASE_SECONDS_PER_YEAR = 1.2; 
            const ROW_HEIGHT = 38; 
            const COMP_BOX_HEIGHT = 70; 
            const COMP_BOX_GAP = 6;
            const SEPARATOR_HEIGHT = 26; 
            
            // --- DOM ELEMENTS ---
            const chart = document.getElementById('ranking-chart');
            const yearDisplay = document.getElementById('year-display-in-column'); 
            const competitionsDisplayContainer = document.getElementById('competitions-display'); 
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const regionFiltersDiv = document.getElementById('region-filters');
            const startEditionSelect = document.getElementById('startEdition');
            const endEditionSelect = document.getElementById('endEdition');
            
            let allCompetitionsContainer = null;
            
            // --- GLOBAL ANIMATION STATE ---
            let allCountries = {};
            let yearlyPoints = {};
            let rawYearlyData = {}; 
            let sortedYears = [];
            let timer = null; 
            let yearIndex = 0; 
            let isPaused = false;
            let animationStarted = false; 
            
            // --- FILTER STATE ---
            let startYear = 1930;
            let endYear = 2022;
            let selectedRegions = new Set();
            
            // --- REGION MAPPING (MODIFIÉ POUR INCLURE MENA) ---
            const regions = {
                'MENA (Moyen-Orient & Afrique du Nord)': [
                    'Algérie', 'Égypte', 'Maroc', 'Tunisie',
                    'Arabie saoudite', 'Iran', 'Irak', 'Koweït', 'Qatar', 'Émirats arabes unis'
                ],
                'Afrique de l\'Ouest': ['Nigeria', 'Ghana', 'Côte d\'Ivoire', 'Sénégal', 'Togo'],
                'Afrique Centrale': ['Cameroun', 'Zaïre'],
                'Afrique Australe': ['Afrique du Sud', 'Angola'],
                'Europe du Nord': ['Danemark', 'Norvège', 'Suède', 'Islande', 'Angleterre', 'Écosse', 'Irlande du Nord', 'Pays de Galles'],
                'Europe du Sud': ['Italie', 'Espagne', 'Portugal', 'Grèce', 'Turquie', 'Chypre', 'Malte', 'Israël'], 
                'Europe de l\'Est': ['Russie', 'Ukraine', 'Pologne', 'Roumanie', 'Hongrie', 'Bulgarie', 'République tchèque', 'Slovaquie', 'Estonie', 'Lettonie', 'Lituanie', 'Biélorussie'],
                'Europe Centrale': ['Allemagne', 'Autriche', 'Suisse', 'Pays-Bas', 'Belgique', 'France'],
                'CONMEBOL (Amérique du Sud)': ['Argentine', 'Brésil', 'Uruguay', 'Chili', 'Pérou', 'Colombie', 'Paraguay', 'Bolivie', 'Équateur', 'Venezuela'],
                'CONCACAF (Amérique du Nord et Centrale)': ['États-Unis', 'Mexique', 'Canada', 'Costa Rica', 'Honduras', 'Salvador', 'Haïti', 'Cuba', 'Jamaïque', 'Trinité-et-Tobago', 'Panama'],
                'Asie Centrale': ['Kazakhstan', 'Ouzbékistan', 'Tadjikistan', 'Kirghizistan', 'Turkménistan'],
                'Asie de l\'Est': ['Corée du Sud', 'Japon', 'Chine', 'Corée du Nord'],
                'Asie du Sud-Est (dont Indes Néerl.)': ['Indes orientales néerlandaises'],
                'Océanie (Australie incluse)': ['Australie', 'Nouvelle-Zélande']
            };
            
            // --- DATA LOADING ---
            
            /** * Function to load and retrieve data from the external JSON file.
             * @returns {Promise<Object>} The data from the JSON file.
             */
            async function loadFifaData() {
                try {
                    // NOTE: Assurez-vous que le fichier 'complet_fifa_rankings_1930_2022.json' se trouve dans le même dossier que ce fichier HTML
                    const response = await fetch('complet_fifa_rankings_1930_2022.json');
                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status}`);
                    }
                    const data = await response.json();
                    if (!data || !data["Coupe du Monde"]) {
                        throw new Error("JSON format is not as expected ('Coupe du Monde' missing).");
                    }
                    return data;
                } catch (error) {
                    console.error("Error loading FIFA data:", error);
                    competitionsDisplayContainer.innerHTML = `<p class="no-competitions" style="color: red; padding: 10px;">ERREUR: Fichier 'complet_fifa_rankings_1930_2022.json' introuvable ou invalide.</p>`;
                    throw error; 
                }
            }
            
            // --- Country Name Mapping and Successor Logic (Unchanged) ---
            const countryMapping = {
                'Allemagne de l\'Ouest': { name: 'West Germany', code: 'DE' }, 
                'Allemagne': { name: 'Germany', code: 'DE' },
                'Germany': { name: 'Germany', code: 'DE' },
                'Argentine': { name: 'Argentina', code: 'AR' },
                'Argentina': { name: 'Argentina', code: 'AR' },
                'Australie': { name: 'Australia', code: 'AU' },
                'Autriche': { name: 'Austria', code: 'AT' },
                'Belgique': { name: 'Belgium', code: 'BE' },
                'Bolivie': { name: 'Bolivia', code: 'BO' },
                'Brésil': { name: 'Brazil', code: 'BR' },
                'Brazil': { name: 'Brazil', code: 'BR' },
                'Bulgarie': { name: 'Bulgaria', code: 'BG' },
                'Cameroun': { name: 'Cameroon', code: 'CM' },
                'Cameroon': { name: 'Cameroon', code: 'CM' },
                'Canada': { name: 'Canada', code: 'CA' },
                'Chili': { name: 'Chile', code: 'CL' },
                'Chine': { name: 'China', code: 'CN' },
                'Colombie': { name: 'Colombia', code: 'CO' },
                'Corée du Nord': { name: 'N. Korea', code: 'KP' },
                'Corée du Sud': { name: 'S. Korea', code: 'KR' },
                'Costa Rica': { name: 'Costa Rica', code: 'CR' },
                'Côte d\'Ivoire': { name: 'Ivory Coast', code: 'CI' },
                'Croatie': { name: 'Croatia', code: 'HR' },
                'Cuba': { name: 'Cuba', code: 'CU' },
                'Tchécoslovaquie': { name: 'Czechoslovakia', code: 'CZ' },
                'République tchèque': { name: 'Czechia', code: 'CZ' },
                'Danemark': { name: 'Denmark', code: 'DK' },
                'Écosse': { name: 'Scotland', code: 'sct' },
                'Égypte': { name: 'Egypt', code: 'EG' },
                'Émirats arabes unis': { name: 'UAE', code: 'AE' },
                'Équateur': { name: 'Ecuador', code: 'EC' },
                'Espagne': { name: 'Spain', code: 'ES' },
                'États-Unis': { name: 'USA', code: 'US' },
                'France': { name: 'France', code: 'FR' },
                'Ghana': { name: 'Ghana', code: 'GH' },
                'Grèce': { name: 'Greece', code: 'GR' },
                'Haïti': { name: 'Haiti', code: 'HT' },
                'Honduras': { name: 'Honduras', code: 'HN' },
                'Hongrie': { name: 'Hungary', code: 'HU' },
                'Indes orientales néerlandaises': { name: 'Dutch East Indies', code: 'ID' },
                'Angleterre': { name: 'England', code: 'eng' },
                'Iran': { name: 'Iran', code: 'IR' },
                'Irak': { name: 'Iraq', code: 'IQ' },
                'Irlande': { name: 'Ireland', code: 'IE' },
                'Irlande du Nord': { name: 'N. Ireland', code: 'nir' },
                'Islande': { name: 'Iceland', code: 'IS' },
                'Israël': { name: 'Israel', code: 'IL' },
                'Italie': { name: 'Italy', code: 'IT' },
                'Jamaïque': { name: 'Jamaica', code: 'JM' },
                'Japon': { name: 'Japan', code: 'JP' },
                'Koweït': { name: 'Kuwait', code: 'KW' },
                'Maroc': { name: 'Morocco', code: 'MA' },
                'Mexique': { name: 'Mexico', code: 'MX' },
                'Nigeria': { name: 'Nigeria', code: 'NG' },
                'Norvège': { name: 'Norway', code: 'NO' },
                'Nouvelle-Zélande': { name: 'New Zealand', code: 'NZ' },
                'Panama': { name: 'Panama', code: 'PA' },
                'Paraguay': { name: 'Paraguay', code: 'PY' },
                'Pays-Bas': { name: 'Netherlands', code: 'NL' },
                'Pays de Galles': { name: 'Wales', code: 'wls' },
                'Pérou': { name: 'Peru', code: 'PE' },
                'Pologne': { name: 'Poland', code: 'PL' },
                'Portugal': { name: 'Portugal', code: 'PT' },
                'Qatar': { name: 'Qatar', code: 'QA' },
                'Roumanie': { name: 'Romania', code: 'RO' },
                'Russie': { name: 'Russia', code: 'RU' },
                'Salvador': { name: 'El Salvador', code: 'SV' },
                'Arabie saoudite': { name: 'Saudi Arabia', code: 'SA' },
                'Sénégal': { name: 'Senegal', code: 'SN' },
                'Serbie': { name: 'Serbia', code: 'RS' },
                'Serbie-et-Monténégro': { name: 'Serbia and Montenegro', code: 'RS' },
                'Slovaquie': { name: 'Slovakia', code: 'SK' },
                'Slovénie': { name: 'Slovenia', code: 'SI' },
                'Suède': { name: 'Sweden', code: 'SE' },
                'Suisse': { name: 'Switzerland', code: 'CH' },
                'Togo': { name: 'Togo', code: 'TG' },
                'Trinité-et-Tobago': { name: 'Trinidad & Tobago', code: 'TT' },
                'Tunisie': { name: 'Tunisia', code: 'TN' },
                'Turquie': { name: 'Turkey', code: 'TR' },
                'Ukraine': { name: 'Ukraine', code: 'UA' },
                'Union soviétique': { name: 'Soviet Union', code: 'su' },
                'Uruguay': { name: 'Uruguay', code: 'UY' },
                'Yougoslavie': { name: 'Yugoslavia', code: 'yu' },
                'Zaïre': { name: 'Zaire', code: 'CD' }, 
                'Afrique du Sud': { name: 'South Africa', code: 'ZA' },
                'Angola': { name: 'Angola', code: 'AO' },
                'Algérie': { name: 'Algeria', code: 'DZ' },
                'Bosnie-Herzégovine': { name: 'Bosnia', code: 'BA' },
                'Allemagne de l\'Est': { name: 'East Germany', code: 'DE' },
                'Biélorussie': { name: 'Belarus', code: 'BY'},
                'Géorgie': { name: 'Georgia', code: 'GE'},
                'Estonie': { name: 'Estonia', code: 'EE'},
                'Lettonie': { name: 'Latvia', code: 'LV'},
                'Lituanie': { name: 'Lithuania', code: 'LT'},
                'Macédoine du Nord': { name: 'N. Macedonia', code: 'MK'},
                'Monténégro': { name: 'Montenegro', code: 'ME'},
                'Venezuela': { name: 'Venezuela', code: 'VE'},
                'Chypre': { name: 'Cyprus', code: 'CY'},
                'Malte': { name: 'Malta', code: 'MT'}
            };
            
            const successorMap = {
                'Yougoslavie': ['Serbie', 'Croatie', 'Bosnie-Herzégovine', 'Slovénie', 'Macédoine du Nord', 'Monténégro'],
                'Serbie-et-Monténégro': ['Serbie', 'Monténégro'],
                'Union soviétique': ['Russie', 'Ukraine', 'Biélorussie', 'Géorgie', 'Estonie', 'Lettonie', 'Lituanie'],
                'Allemagne de l\'Ouest': ['Allemagne'],
                'Allemagne de l\'Est': ['Allemagne'],
                'Tchécoslovaquie': ['République tchèque', 'Slovaquie'],
            };

            function getCountryInfo(countryName) {
                let info = countryMapping[countryName];
                if (!info) {
                    const tempCode = countryName.substring(0, 2).toLowerCase();
                    return { name: countryName, code: tempCode };
                }
                return info;
            }
            
            // Map to check if a country is in a selected region
            let modernCountryToRegion = {};
            function populateModernCountryToRegion() {
                for (const regionName in regions) {
                    regions[regionName].forEach(originalName => {
                        const modernName = getCountryInfo(originalName).name;
                        modernCountryToRegion[modernName] = regionName; 
                    });
                }
            }

            function distributePoints(points) {
                const distributedPoints = {};

                for (const countryName in points) {
                    const pointValue = points[countryName];
                    const successors = successorMap[countryName];
                    
                    if (successors) {
                        const splitPoints = pointValue / successors.length;
                        successors.forEach(successorKey => {
                            const modernCountryName = getCountryInfo(successorKey).name;
                            distributedPoints[modernCountryName] = (distributedPoints[modernCountryName] || 0) + splitPoints;
                        });
                    } else {
                        const modernCountryName = getCountryInfo(countryName).name;
                        distributedPoints[modernCountryName] = (distributedPoints[modernCountryName] || 0) + pointValue;
                    }
                }
                
                return distributedPoints;
            }
            
            // --- END OF POINT DISTRIBUTION LOGIC ---

            // --- NAVIGATION FUNCTIONS ---

            window.showFilterScreen = function() {
                const startScreen = document.getElementById('start-screen');
                // Cacher l'écran de départ avec animation
                gsap.to(startScreen, { opacity: 0, visibility: 'hidden', duration: 0.3, onComplete: () => {
                    startScreen.style.display = 'none';
                    
                    // Afficher l'écran de filtre avec animation
                    const filterScreen = document.getElementById('filter-screen');
                    filterScreen.style.display = 'flex';
                    gsap.to(filterScreen, { opacity: 1, visibility: 'visible', duration: 0.3 });
                    
                    // Assurer que les filtres sont initialisés une seule fois
                    if (regionFiltersDiv.children.length === 0) {
                        initFilterElements();
                    }
                }});
            }

            window.startRanking = function() {
                // 1. Appliquer les filtres et ré-analyser les données
                applyFilters();
                
                // 2. Cacher l'écran de filtre
                const filterScreen = document.getElementById('filter-screen');
                gsap.to(filterScreen, { opacity: 0, visibility: 'hidden', duration: 0.3, onComplete: () => {
                    filterScreen.style.display = 'none';
                    
                    // 3. Lancer l'animation
                    if (!animationStarted) {
                        startAll(); 
                        animationStarted = true;
                        
                        // Attacher le listener Pause/Play au contenu principal
                        mainContentWrapper.addEventListener('pointerdown', togglePause);
                    }
                }});
            }
            
            async function init() {
                try {
                    const fifaData = await loadFifaData();
                    const worldCupData = transformFifaData(fifaData);
                    
                    rawYearlyData = worldCupData; 
                    sortedYears = Object.keys(rawYearlyData).sort((a, b) => parseInt(a) - parseInt(b));
                    
                    populateModernCountryToRegion(); // Mettre à jour le mapping région
                    
                    initEditionFilters(); // Remplir les select options des éditions
                    
                } catch (error) {
                    yearDisplay.textContent = "Error";
                    console.error("Initialization Error:", error);
                }
            }
            
            // --- FILTER INITIALIZATION & LOGIC ---

            function initFilterElements() {
                let html = '';
                for (const regionName in regions) {
                    const id = `region-${regionName.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    html += `
                        <div class="region-item">
                            <input type="checkbox" id="${id}" data-region="${regionName}" checked>
                            <label for="${id}">${regionName}</label>
                        </div>
                    `;
                    selectedRegions.add(regionName); // Sélectionner tout par défaut
                }
                regionFiltersDiv.innerHTML = html;
                
                // Ajouter les listeners pour mettre à jour l'ensemble des régions sélectionnées
                document.querySelectorAll('.region-item input').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const region = e.target.dataset.region;
                        if (e.target.checked) {
                            selectedRegions.add(region);
                        } else {
                            selectedRegions.delete(region);
                        }
                    });
                });
            }

            function initEditionFilters() {
                startEditionSelect.innerHTML = '';
                endEditionSelect.innerHTML = '';
                
                // Créer la liste des éditions complètes
                const editions = sortedYears.map(year => {
                    const data = rawYearlyData[year];
                    const organizer = data ? getCountryInfo(data.organizer).name : 'Inconnu';
                    return { year: year, text: `${organizer} - ${year}` };
                });
                
                editions.forEach((edition, index) => {
                    const startOption = document.createElement('option');
                    startOption.value = edition.year;
                    startOption.textContent = edition.text;
                    startEditionSelect.appendChild(startOption);

                    const endOption = document.createElement('option');
                    endOption.value = edition.year;
                    endOption.textContent = edition.text;
                    endEditionSelect.appendChild(endOption);

                    // Sélectionner la première et la dernière édition par défaut
                    if (index === 0) startOption.selected = true;
                    if (index === editions.length - 1) endOption.selected = true;
                });
                
                startEditionSelect.addEventListener('change', () => {
                    const startY = parseInt(startEditionSelect.value);
                    const endY = parseInt(endEditionSelect.value);
                    if (startY > endY) {
                        endEditionSelect.value = startEditionSelect.value;
                    }
                });
                
                endEditionSelect.addEventListener('change', () => {
                    const startY = parseInt(startEditionSelect.value);
                    const endY = parseInt(endEditionSelect.value);
                    if (endY < startY) {
                        startEditionSelect.value = endEditionSelect.value;
                    }
                });
            }
            
            function applyFilters() {
                // 1. Mettre à jour les années de début et de fin
                startYear = parseInt(startEditionSelect.value);
                endYear = parseInt(endEditionSelect.value);
                
                // 2. Recalculer les points et la liste des pays basée sur les filtres
                parseFilteredData(rawYearlyData);
                
                // 3. Recréer les éléments DOM du classement avec la nouvelle liste de pays
                createDOMElements(); 
            }
            
            // --- DATA PARSING WITH FILTERS ---

            function transformFifaData(data) {
                const transformedData = {};
                data["Coupe du Monde"].forEach(edition => {
                    const year = edition.edition;
                    const organizer = edition.pays_hote;
                    const points = {};
                    edition.resultats.forEach(result => {
                        points[result.equipe] = result.total_points; 
                    });
                    transformedData[year] = {
                        organizer: organizer,
                        points: points
                    };
                });
                return transformedData;
            }


            function parseFilteredData(data) {
                // Réinitialiser les structures globales
                yearlyPoints = {}; 
                allCountries = {}; 
                
                const allModernCountries = new Set();
                
                // 1. Identifier les années filtrées
                const filteredYears = sortedYears.filter(year => 
                    parseInt(year) >= startYear && parseInt(year) <= endYear
                );
                
                // Itérer sur les années filtrées pour accumuler les points et identifier les pays
                filteredYears.forEach(year => {
                    const yearData = data[year];
                    const distributed = distributePoints(yearData.points);
                    yearlyPoints[year] = distributed; 
                    
                    Object.keys(distributed).forEach(countryKey => allModernCountries.add(countryKey));
                });
                
                // 2. Créer la liste finale de `allCountries` en appliquant le filtre de région
                allModernCountries.forEach(countryName => {
                    const region = modernCountryToRegion[countryName];
                    
                    if (selectedRegions.has(region)) {
                        let originalKey = Object.keys(countryMapping).find(key => countryMapping[key].name === countryName);
                        if (!originalKey) {
                            originalKey = countryName; 
                        }
                        const info = getCountryInfo(originalKey);
                        allCountries[countryName] = { 
                            key: countryName, 
                            name: countryName, 
                            code: info.code, 
                            totalPoints: 0, 
                            element: null, 
                            hasAppeared: false 
                        };
                    }
                });
                
                // Réinitialiser le classement à zéro pour le début de l'animation
                Object.values(allCountries).forEach(c => c.totalPoints = 0);
            }

            function getFlagSrc(countryCode) {
                const specialCodes = {
                    'eng': 'gb-eng',
                    'sct': 'gb-sct',
                    'wls': 'gb-wls',
                    'nir': 'gb-nir',
                    'su': 'su',
                    'yu': 'yu',
                    'xx': 'xx'
                };
                
                const code = specialCodes[countryCode] || countryCode;
                return `https://flagcdn.com/w40/${code.toLowerCase()}.png`;
            }

            function createDOMElements() {
                // Nettoyer l'ancienne chart
                chart.innerHTML = ''; 
                
                const countriesArray = Object.values(allCountries).sort((a, b) => a.name.localeCompare(b.name));
                countriesArray.forEach((country, index) => {
                    const row = document.createElement('div');
                    row.className = 'country-row';
                    gsap.set(row, { opacity: 0, visibility: 'hidden' }); 
                    
                    const flagSrc = getFlagSrc(country.code);

                    row.innerHTML = `<div class="country-info">
                            <img src="${flagSrc}" onerror="this.src='${getFlagSrc('xx')}'" alt="${country.name} Flag" class="flag">
                            <span class="country-name">${country.name}</span>
                            <div class="progress-container"><div class="progress-bar"></div></div>
                            <span class="trophy-count">0</span>
                        </div>`;
                    chart.appendChild(row);
                    allCountries[country.key].element = row;
                });

                // Réinitialiser le conteneur des compétitions
                if (allCompetitionsContainer) {
                    allCompetitionsContainer.innerHTML = '';
                } else {
                    allCompetitionsContainer = document.createElement('div');
                    allCompetitionsContainer.id = 'all-competitions-scroll-container';
                    competitionsDisplayContainer.innerHTML = '';
                    competitionsDisplayContainer.appendChild(allCompetitionsContainer);
                }
                
                gsap.set(allCompetitionsContainer, { position: 'relative', y: 0 }); 
            }
            
            function startAll() {
                startAnimation();
            }

            /**
             * Toggles the animation state between paused and running.
             */
            window.togglePause = function() {
                if (!animationStarted) return; 

                isPaused = !isPaused;
                if (isPaused) {
                    clearTimeout(timer);
                    yearDisplay.textContent = `${sortedYears.filter(y => parseInt(y) >= startYear && parseInt(y) <= endYear)[yearIndex - 1] || startYear} (PAUSE)`;
                } else {
                    yearDisplay.textContent = `${sortedYears.filter(y => parseInt(y) >= startYear && parseInt(y) <= endYear)[yearIndex - 1] || startYear}`;
                    runNextYear(); 
                }
            }


            function runNextYear() {
                if (isPaused) return;

                const filteredYears = sortedYears.filter(year => 
                    parseInt(year) >= startYear && parseInt(year) <= endYear
                );
                
                if (yearIndex >= filteredYears.length) { 
                    yearDisplay.textContent = `FINAL (${endYear})`;
                    return;
                }

                const currentYear = filteredYears[yearIndex];
                
                updateRankingForYear(currentYear);
                updateCompetitionsDisplay(currentYear, true);
                
                yearIndex++; 

                if (yearIndex < filteredYears.length) {
                    timer = setTimeout(runNextYear, BASE_SECONDS_PER_YEAR * 1000);
                }
            }

            function startAnimation() {
                yearIndex = 0; 
                
                const filteredYears = sortedYears.filter(year => 
                    parseInt(year) >= startYear && parseInt(year) <= endYear
                );
                
                if (filteredYears.length > 0) { 
                    const currentYear = filteredYears[yearIndex];

                    updateCompetitionsDisplay(currentYear, false);
                    updateRankingForYear(currentYear);
                    yearIndex++; 
                    
                    if (yearIndex < filteredYears.length) {
                        const firstYearDelay = BASE_SECONDS_PER_YEAR * 1000;
                        timer = setTimeout(runNextYear, firstYearDelay);
                    } else {
                         yearDisplay.textContent = `FINAL (${endYear})`;
                    }
                } else {
                    yearDisplay.textContent = `Aucune Édition`;
                }
            }

            function updateRankingForYear(year) {
                yearDisplay.textContent = `${year}`; 
                
                let maxPoints = 0;

                const pointsThisYear = yearlyPoints[year];
                if (pointsThisYear) {
                    for (const countryKey in pointsThisYear) {
                        if (allCountries[countryKey]) {
                            // Points are ADDED CUMULATIVELY
                            allCountries[countryKey].totalPoints += pointsThisYear[countryKey];
                        }
                    }
                }

                const rankedCountries = Object.values(allCountries)
                    .filter(country => country.totalPoints > 0) 
                    .sort((a, b) => b.totalPoints - a.totalPoints || a.name.localeCompare(b.name)); 
                
                maxPoints = Math.max(1, rankedCountries[0] ? rankedCountries[0].totalPoints : 0);
                
                chart.style.height = `${rankedCountries.length * ROW_HEIGHT}px`;

                rankedCountries.forEach((country, index) => {
                    const countryRow = country.element;
                    if (!countryRow) {
                        return; 
                    }
                    
                    const progressBar = countryRow.querySelector('.progress-bar');
                    const trophyCount = countryRow.querySelector('.trophy-count');
                    const newY = index * ROW_HEIGHT;
                    const rank = index + 1; 

                    let progressBarBackground = 'linear-gradient(90deg, #FFD700, #DAA520)'; // Gold
                    if (rank === 2) {
                        progressBarBackground = 'linear-gradient(90deg, #C0C0C0, #A9A9A9)'; // Silver
                    } else if (rank === 3) {
                        progressBarBackground = 'linear-gradient(90deg, #CD7F32, #B87333)'; // Bronze
                    } else if (rank > 3) {
                        progressBarBackground = 'linear-gradient(90deg, #4e73df, #224abe)'; // Blue
                    }

                    if (country.totalPoints > 0 && !country.hasAppeared) {
                        country.hasAppeared = true;
                        gsap.fromTo(countryRow, { y: newY, opacity: 0, visibility: 'visible' }, { y: newY, opacity: 1, duration: 0.8, ease: 'power3.out' });
                    } 
                    else if (country.hasAppeared) {
                        gsap.to(countryRow, { y: newY, duration: .5, ease: 'power3.inOut' });
                        gsap.set(countryRow, { visibility: 'visible', opacity: 1 });
                    }

                    if (country.hasAppeared) {
                        gsap.to(progressBar, { 
                            width: `${(country.totalPoints / maxPoints) * 100}%`, 
                            background: progressBarBackground, 
                            duration: 0.5, 
                            ease: 'power3.inOut' 
                        });
                        gsap.to(trophyCount, { 
                            innerText: Math.round(country.totalPoints), 
                            duration: 0.8, 
                            snap: { innerText: 1 }, 
                            ease: 'power1.inOut' 
                        });
                    }
                });

                Object.values(allCountries).forEach(country => {
                    if (country.totalPoints === 0 && country.element) {
                        gsap.set(country.element, { opacity: 0, visibility: 'hidden' });
                    }
                });
            }

            function updateCompetitionsDisplay(year, animate = true) {
                const yearData = rawYearlyData[year] || {};
                
                const organizerName = yearData.organizer || 'Inconnu';
                const organizerInfo = getCountryInfo(organizerName);
                const organizerFlagSrc = getFlagSrc(organizerInfo.code);
                
                let winnerName = 'Inconnu';
                if (yearData.points) {
                    winnerName = Object.keys(yearData.points).reduce((a, b) => (yearData.points[a] || 0) > (yearData.points[b] || 0) ? a : b, 'Inconnu');
                }
                const winnerInfo = getCountryInfo(winnerName);
                const winnerFlagSrc = getFlagSrc(winnerInfo.code);

                const yearContainer = document.createElement('div');
                yearContainer.className = 'year-group-container';
                
                let totalYearHeight = 0; 
                
                const separator = document.createElement('div');
                separator.className = 'year-separator';
                separator.innerHTML = `<span class="year-separator-text">${year}</span>`;
                yearContainer.appendChild(separator);
                totalYearHeight += SEPARATOR_HEIGHT; 

                const box = document.createElement('div');
                box.className = 'competition-box';
                
                box.innerHTML += `
                    <div class="comp-info-row organizer">
                        <span class="row-label">Hôte:</span>
                        <img src="${organizerFlagSrc}" onerror="this.src='${getFlagSrc('xx')}'" alt="Host Flag" class="row-flag">
                        <span class="row-text">${organizerInfo.name}</span>
                    </div>
                `;
                
                box.innerHTML += `
                    <div class="comp-info-row winner">
                        <span class="row-label">Vainqueur:</span>
                        <img src="${winnerFlagSrc}" onerror="this.src='${getFlagSrc('xx')}'" alt="Winner Flag" class="row-flag">
                        <span class="row-text">${winnerInfo.name}</span>
                    </div>
                `;
                
                yearContainer.appendChild(box);
                totalYearHeight += COMP_BOX_HEIGHT + COMP_BOX_GAP;
                
                totalYearHeight -= COMP_BOX_GAP; 
                yearContainer.style.marginBottom = `${COMP_BOX_GAP}px`;
                totalYearHeight += COMP_BOX_GAP; 

                const scrollDistance = totalYearHeight; 
                
                gsap.set(yearContainer, { height: totalYearHeight - COMP_BOX_GAP }); 

                allCompetitionsContainer.prepend(yearContainer);

                if (animate) {
                    gsap.set(allCompetitionsContainer, { y: -scrollDistance });
                    
                    gsap.to(allCompetitionsContainer, {
                        y: 0, 
                        duration: BASE_SECONDS_PER_YEAR * 0.9, 
                        ease: 'power3.out'
                    });
                }
            }

            init();
        });
    </script>
</body>
</html>
