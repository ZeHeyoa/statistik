<!doctype html>

<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Camera 3D - Rotation infinie avec 3 nipples (Pitch/Yaw/Roll)</title>
<style>
html,body { margin:0; height:100%; overflow:hidden; background:#0b0f15; font-family:sans-serif; user-select:none; }
.viewport { width:100%; height:100%; perspective:1000px; overflow:hidden; position:relative; }
.camera { width:100%; height:100%; transform-style:preserve-3d; transform: translateZ(0px) rotateX(10deg) rotateY(0deg); }
.world { position:relative; width:100%;height:100%; transform-style:preserve-3d; }
.box { position:absolute; width:140px;height:140px; left:50%;top:50%; margin-left:-70px; margin-top:-70px; transform-style:preserve-3d; background:linear-gradient(180deg,#08f,#004); box-shadow:0 20px 40px rgba(0,0,0,0.4); }
.box:nth-child(2){transform:translateX(-300px) translateZ(200px) rotateY(30deg);background:linear-gradient(#8f8,#060);} 
.box:nth-child(3){transform:translateX(250px) translateZ(-100px) rotateY(-40deg);background:linear-gradient(#f8f,#606);} 
.ground { position:absolute; width:3000px;height:3000px; left:50%;top:100%; transform:translate(-50%,-50%) rotateX(90deg) translateZ(-400px); background:repeating-linear-gradient(0deg,#111 0 40px,#141414 40px 80px); }/* Joysticks */ #leftJoy { position:fixed; bottom:40px; left:40px; width:160px; height:160px; z-index:100; touch-action:none; } #rightJoyGroup { position: fixed; bottom: 40px; right: 40px; width: 220px; height: 220px; z-index: 100; touch-action: none; } .rotation-zone { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border-radius: 50%; transition: box-shadow 0.2s ease; } #zoneZ { width: 200px; height: 200px; z-index: 101; } #zoneY { width: 140px; height: 140px; z-index: 102; } #zoneX { width: 80px; height: 80px; z-index: 103; } .rotation-zone::before { content: ''; position: absolute; left: 0; top: 0; width: 100%; height: 100%; border: 2px dashed rgba(255,255,255,0.05); border-radius: 50%; pointer-events: none; } .rotation-zone.active { box-shadow: 0 0 25px 5px rgba(255,255,255,0.2) inset; } #angle-info { position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); color: #00ffff; font-size: 11px; background: rgba(0, 0, 0, 0.5); padding: 2px 6px; border-radius: 3px; white-space: nowrap; z-index: 120; } .info { position:fixed; top:10px;left:10px; color:#ccc; font-size:13px; } </style>

</head>
<body>
<div class="viewport">
  <div class="camera" id="camera">
    <div class="world">
      <div class="box"></div>
      <div class="box"></div>
      <div class="box"></div>
      <div class="ground"></div>
    </div>
  </div>
</div><div id="leftJoy"></div><div id="rightJoyGroup">
  <div id="zoneZ" class="rotation-zone"></div>
  <div id="zoneY" class="rotation-zone"></div>
  <div id="zoneX" class="rotation-zone"></div>
  <div id="angle-info"></div>
</div>
<div class="info">Joystick gauche = déplacement • X (rouge) = Pitch • Y (vert) = Yaw • Z (bleu) = Roll — rotations infinies cumulatives</div><script src="nipple.js"></script><script>
document.addEventListener('DOMContentLoaded', () => {
  const cam = document.getElementById('camera');
  const angleInfo = document.getElementById('angle-info');
  const leftJoyContainer = document.getElementById('leftJoy');

  const zoneX = document.getElementById('zoneX');
  const zoneY = document.getElementById('zoneY');
  const zoneZ = document.getElementById('zoneZ');

  let rotX = 10, rotY = 0, rotZ = 0;
  let targetX = rotX, targetY = rotY, targetZ = rotZ;
  let camX = 0, camY = 10, camZ = -600;
  let velX = 0, velZ = 0;
  const moveSpeed = 2.0;
  const lerp = (a,b,t)=>a+(b-a)*t;

  const sensitivity = {
    pitch: 0.5,
    yaw: 1.0,
    roll: 0.8
  };

  if (typeof nipplejs !== 'undefined' && nipplejs.create) {
    // --- Joystick gauche ---
    const left = nipplejs.create({ zone: leftJoyContainer, mode:'static', position:{left:'50%',top:'50%'}, color:'white', size:120 });
    left.on('move', (evt,data)=>{
      if(!data.angle) return;
      const rad=data.angle.radian; const force=data.force||0;
      const camRad=rotY*Math.PI/180;
      const inputVelZ=-Math.sin(rad)*moveSpeed*force;
      const inputVelX=Math.cos(rad)*moveSpeed*force;
      velX=Math.sin(camRad)*inputVelZ+Math.cos(camRad)*inputVelX;
      velZ=Math.cos(camRad)*inputVelZ-Math.sin(camRad)*inputVelX;
    });
    left.on('end',()=>{velX=0;velZ=0;});

    // --- Rotation infinie cumulative ---
    function setupRotJoy(zone, color, onRotate) {
      const joy = nipplejs.create({ zone, mode:'static', position:{left:'50%',top:'50%'}, color, size: parseInt(zone.style.width)||100 });
      let prevAngle = null;
      joy.on('start', ()=> zone.classList.add('active'));
      joy.on('move', (e, d) => {
        if(!d.angle) return;
        const a = d.angle.degree;
        if(prevAngle === null) { prevAngle = a; return; }
        let delta = a - prevAngle;
        if (delta > 180) delta -= 360;
        if (delta < -180) delta += 360;
        onRotate(delta);
        prevAngle = a;
      });
      joy.on('end', ()=> { prevAngle = null; zone.classList.remove('active'); });
    }

    setupRotJoy(zoneX, 'red', delta => { targetX += delta * sensitivity.pitch; });
    setupRotJoy(zoneY, 'lime', delta => { targetY += delta * sensitivity.yaw; });
    setupRotJoy(zoneZ, 'blue', delta => { targetZ += delta * sensitivity.roll; });
  }

  const norm=a=>((Math.round(a)%360)+360)%360;

  function update(){
    rotX=lerp(rotX,targetX,0.15);
    rotY=lerp(rotY,targetY,0.15);
    rotZ=lerp(rotZ,targetZ,0.15);
    camX+=velX; camZ+=velZ;
    cam.style.transform=`rotateZ(${-rotZ}deg) rotateY(${-rotY}deg) rotateX(${-rotX}deg)`+` translateX(${-camX}px) translateY(${-camY}px) translateZ(${-camZ}px)`;
    angleInfo.textContent=`Pitch: ${norm(rotX)}° | Yaw: ${norm(rotY)}° | Roll: ${norm(rotZ)}°`;
    requestAnimationFrame(update);
  }
  requestAnimationFrame(update);
});
</script></body>
</html>